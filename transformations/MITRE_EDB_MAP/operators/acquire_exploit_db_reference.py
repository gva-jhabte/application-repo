from gva.flows import BaseOperator
import pandas as pd
import re


def find_cves(string):
    tokens = re.findall(r"(?i)CVE.\d{4}-\d{4,7}\b", string)
    for token in tokens:
        token = token.upper().strip()
        token = token[:3] + '-' + token[4:]  # snort rules list cves as CVE,2009-0001
        yield {'CVE': token}


class AcquireExploitDbReference(BaseOperator):

    def execute(self, data, context):
        edb = pd.read_html('https://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html')
        edb = edb[3]  # it's the forth table on the page
        for index, row in edb.iterrows():
            exploit_ref = row[0]
            for cve in find_cves(row[1]):
                cve['ExploitDB'] = exploit_ref
                yield cve, context
