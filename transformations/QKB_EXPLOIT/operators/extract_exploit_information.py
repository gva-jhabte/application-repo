"""
Extract the details from the EXPLOITS section of the Qualys Knowledge Base
"""
from gva.flows import BaseOperator


class ExtractExploitInformationOperator(BaseOperator):

    def execute(self, data, context):
        """
        Interpret each line of data from the file, load into XML and then extract the required data
        """
        QID = data.get('QID')
        if data.get('CORRELATION'):
            if data['CORRELATION'].get('EXPLOITS'):
                if data['CORRELATION']['EXPLOITS'].get('EXPLT_SRC'):
                    exploit_sources = data['CORRELATION']['EXPLOITS']['EXPLT_SRC']
                    if not type(exploit_sources) is list:
                        exploit_sources = [exploit_sources]
                    for exploits in exploit_sources:
                        source = exploits['SRC_NAME']
                        exploit_details = exploits['EXPLT_LIST']['EXPLT']
                        if not type(exploit_details) is list:
                            exploit_details = [exploit_details]
                        for exploit in exploit_details:
                            row = {
                                "QID": QID,
                                "CVE": exploit.get('REF'),
                                "Database": source,
                                "Reference": exploit.get('LINK')
                            }
                            yield row, context
